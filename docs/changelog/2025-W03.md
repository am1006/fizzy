# Fizzy Changelog - Week 03, 2025

**Period**: January 13 - January 20, 2025
**Total Commits**: 105
**Contributors**: Kevin McConnell (60), Jason Zimdars (23), Jose Farias (22)

## Highlights

This was a major feature development week with three significant systems landing: a complete notifications infrastructure with real-time tray UI, a draggable divider for the bubble list, and an activity timeline view. The team also refined the draft/published bubble workflow and improved keyboard navigation throughout the app. Filter logic was simplified with a cleaner params normalization approach.

## Detailed Changes

### New Features

#### Notifications System (PR #199)
A comprehensive notifications system was built from the ground up, enabling real-time user notifications with tray display and an index view.

- Files affected:
  - `app/models/notification.rb` - Core model with read/unread states, polymorphic source
  - `app/models/notifier.rb` - Factory pattern for generating notifications from events
  - `app/controllers/notifications_controller.rb` - Index and tray endpoints
  - `app/views/notifications/_tray.html.erb` - Slide-out tray with Turbo Streams
  - `app/views/notifications/index.html.erb` - Full notification history page
  - `app/assets/stylesheets/notifications.css` - Complete styling for tray and index

- Technical notes:
  - Notifications are broadcast in real-time via Turbo Streams (`turbo_stream_from Current.user, :notifications`)
  - Uses polymorphic `source` association linking to Events
  - Read state changed from boolean to `read_at` timestamp for better tracking
  - Tray opens on click with keyboard shortcut `N` for quick access
  - Notifications link directly to the relevant comment or card
  - "Mark all read" functionality via bulk readings controller
  - Unread dot indicator and empty states ("New for you") implemented

#### Activity Timeline
A new activity/events index page showing all account activity organized by day.

- Files affected:
  - `app/controllers/events_controller.rb` - Day-scoped event loading
  - `app/views/events/index.html.erb` - Timeline UI with lazy-loading
  - `app/helpers/events_helper.rb` - Day grouping and formatting helpers
  - `app/javascript/controllers/fetch_on_visible_controller.js` - Intersection Observer for lazy loading

- Technical notes:
  - Events grouped by day with "today", "yesterday", and weekday labels
  - Uses `IntersectionObserver` for lazy-loading older days as user scrolls
  - Turbo Stream responses for pagination to avoid full page reloads
  - Added direct association between Event and Bubble (`belongs_to :bubble`) to simplify querying

#### Draggable Bubble Divider (PR #207, #209)
Users can now drag a divider to reposition bubbles in the list view.

- Files affected:
  - `app/javascript/controllers/divider_controller.js` - Drag-and-drop logic
  - `app/views/bubbles/list/_divider.html.erb` - Divider partial
  - `app/views/bubbles/index.html.erb` - Integration with bubble list
  - `app/assets/stylesheets/bubbles.css` - Divider styling

- Technical notes:
  - Uses distance-to-nearest-edge calculation for smooth positioning
  - Controller handles drag events and repositions divider between bubbles
  - Follow-up PR fixed jankiness in drag behavior with improved overlap logic

### Enhancements

#### Draft/Published Bubble States (PR #195)
Bubbles now have explicit `drafted` and `published` states with visual treatment.

- Files affected:
  - `app/models/bubble/draftable.rb` - State management concern
  - `app/views/bubbles/show.html.erb` - Draft banner display
  - `app/views/bubbles/_publish.html.erb` - Publish action
  - `app/assets/stylesheets/bubbles.css` - Dashed outline for drafts

- Technical notes:
  - Drafts display a visual banner indicating unpublished state
  - Dashed outline styling applied wherever drafts appear (list, bucket views)
  - Notifications are suppressed while bubbles are still in draft state
  - Migration added `status` column to bubbles table

#### Keyboard Navigation Improvements
Enhanced escape key handling for better navigation flow.

- Files affected:
  - `app/views/bubbles/index.html.erb`
  - Multiple form and dialog views

- Technical notes:
  - `Esc` now navigates back to buckets index from bubble list
  - Escape key properly closes dialogs without triggering back navigation
  - Cancel behavior refined for forms with autofocused inputs
  - Comment edit cancellation no longer triggers unwanted back navigation

#### Local Time Formatting
A new cache-friendly approach to displaying relative times.

- Files affected:
  - `app/helpers/time_helper.rb` - Server-side helpers
  - `app/javascript/controllers/local_time_controller.js` - Client-side formatting

- Technical notes:
  - Times rendered as Unix timestamps, formatted client-side with JavaScript
  - Multiple format options: `ago`, `daysago`, `indays`, `agoorweekday`, `timeordate`
  - Relative times refresh every 30 seconds automatically
  - Fixed rounding issue (1.5 days now shows as "1 day ago" not "2 days ago")
  - Enables better fragment caching since times don't change the cache key

### Refactoring

#### Filter Simplification (PR #205)
The filter system was streamlined with cleaner parameter handling.

- Files affected:
  - `app/models/filter.rb`
  - `app/models/filter/params.rb`
  - `app/models/filter/fields.rb`
  - `test/models/filter_test.rb`

- Technical notes:
  - Renamed `default_fields` to `default_values` for clarity
  - Removed redundant `digest_params` instance method
  - Parameter normalization now handles array values consistently (converting to strings, sorting)
  - Added test coverage for equivalent filters created by different users

#### Message Reflow
Comments now properly reflow with improved layout handling.

- Files affected:
  - `app/models/bubble/messages.rb`
  - `app/views/comments/_body.html.erb`
  - `app/models/event_summary.rb`

- Technical notes:
  - Reflow operations now wrapped in database transactions
  - Added `body` column to event_summary for denormalized content

### Bug Fixes

- **Divider drag jankiness** (PR #209): Fixed jerky behavior when dragging the bubble divider by improving overlap detection logic and using distance to nearest edge
- **Time rounding**: Fixed `AgoFormatter` to floor instead of round (1.5 days shows as "1 day ago")
- **Dockerfile casing warning**: Fixed case sensitivity warning in Docker build
- **Migration safety**: Ensured drafts migration doesn't unpublish existing bubbles

### Infrastructure

- **Deployment targets renamed**: Updated deployment configuration with new naming
- **libyaml dependency**: Added missing libyaml to Docker image
- **Gemfile cleanup**: Tidied up gem declarations
- **hotwire_combobox update**: Bumped from `57ee6c9` to `c280da0`

### Testing

- Added controller tests for readings and notifications controllers
- Added test for equivalent filters with different users
- Added tests for bubble draftable concern
- Fixed and adjusted multiple test fixtures to match expected content

## Areas of Active Development

1. **Notifications** - Most actively modified area (14 changes to helper, 13 to stylesheet, 12 to partial)
2. **Divider controller** - 10 changes refining drag behavior
3. **Events/Activity** - New feature with timeline display
4. **Filters** - Ongoing simplification work

## Things to Watch

1. **Notification tray UX**: The tray system is new and may evolve based on user feedback. Watch for performance considerations with real-time Turbo Streams.

2. **Event-Bubble association**: A new direct `belongs_to :bubble` was added to Event. This is a schema change that future features may leverage.

3. **Draft workflow**: The drafted/published state machine is now in place. Consider how this interacts with entropy and auto-postponement.

4. **Local time controller**: The client-side time formatting is sophisticated but complex. Watch for timezone edge cases.

## Recommended Commits to Review

1. **`952895ae6`** - Initial notifications tray implementation (good overview of the pattern)
2. **`dac9aa9d2`** - Drag bubble divider (shows Stimulus controller patterns)
3. **`6f8c92989`** - Cache-friendly time formatting (demonstrates client-side hydration pattern)
4. **`e9a085f84`** - Filter simplification (good refactoring example)
5. **`e6fe7f680`** - Event-Bubble association (schema change with clear rationale)
